# this focuses on large table
import json
import pytest
from gmft import AutoFormatConfig, AutoTableDetector, AutoTableFormatter
from gmft.pdf_bindings.bindings_pdfium import PyPDFium2Document
from gmft.table_function import TATRFormattedTable


@pytest.fixture
def doc_nmr():
    doc = PyPDFium2Document(f"notebooks/samples/nmr.pdf")

    yield doc
    # cleanup
    doc.close()
    
def load_to_str(doc, page_no):
    # for i, doc in enumerate(docs_bulk):
    
    config = AutoFormatConfig()
    # config.large_table_threshold = 0
    # config.large_table_row_overlap_threshold = -1
    # config.remove_null_rows = False
    config.force_large_table_assumption = True
    with open(f"test/outputs/nmr/nmr{page_no}.json", "r") as f:
        as_dict = json.load(f)
        page_no = as_dict["page_no"]
        page = doc[page_no]
        ft = TATRFormattedTable.from_dict(as_dict, page)

        df = ft.df(config_overrides=config)
        return df.to_csv(index=False, lineterminator="\n")

def test_large_table_2(doc_nmr):
    # 2
    actual = load_to_str(doc_nmr, 2)
    expected = """,pr ot on,m ult,CDCl3,(CD3)2CO,(CD3)2SO,C6D6,CD3CN,CD3OD,D2O
solvent r esidu al pea k,,,7.26,2.05,2.50,7.16,1.94,3.31,4.79
H2O,,s,1.56,2.84a,3.33a,0.40,2.13,4.87,
a cetic a cid,CH3,s,2.10,1.96,1.91,1.55,1.96,1.99,2.08
a cet on e,CH3,s,2.17,2.09,2.09,1.55,2.08,2.15,2.22
a cet onit rile,CH3,s,2.10,2.05,2.07,1.55,1.96,2.03,2.06
benzene,CH,s,7.36,7.36,7.37,7.15,7.37,7.33,
tert-but yl alcoh ol,CH3,s,1.28,1.18,1.11,1.05,1.16,1.40,1.24
,OHc,s,,,4.19,1.55,2.18,,
tert-but yl m et h yl et h er,CCH3,s,1.19,1.13,1.11,1.07,1.14,1.15,1.21
,OCH3,s,3.22,3.13,3.08,3.04,3.13,3.20,3.22
BHTb,ArH,s,6.98,6.96,6.87,7.05,6.97,6.92,
,OHc,s,5.01,,6.65,4.79,5.20,,
,ArCH3,s,2.27,2.22,2.18,2.24,2.22,2.21,
,ArC(CH3)3,s,1.43,1.41,1.36,1.38,1.39,1.40,
chlor oform,CH,s,7.26,8.02,8.32,6.15,7.58,7.90,
cycloh exa n e,CH2,s,1.43,1.43,1.40,1.40,1.44,1.45,
"1,2-dichlor oet h a n e",CH2,s,3.73,3.87,3.90,2.90,3.81,3.78,
dichlor om et h a n e,CH2,s,5.30,5.63,5.76,4.27,5.44,5.49,
diethyl ether,CH3,"t, 7",1.21,1.11,1.09,1.11,1.12,1.18,1.17
,CH2,"q, 7",3.48,3.41,3.38,3.26,3.42,3.49,3.56
diglyme,CH2,m,3.65,3.56,3.51,3.46,3.53,3.61,3.67
,CH2,m,3.57,3.47,3.38,3.34,3.45,3.58,3.61
,OCH3,s,3.39,3.28,3.24,3.11,3.29,3.35,3.37
"1,2-dim et h oxyet h a n e",CH3,s,3.40,3.28,3.24,3.12,3.28,3.35,3.37
,CH2,s,3.55,3.46,3.43,3.33,3.45,3.52,3.60
dim et h yla cet amide,CH3CO,s,2.09,1.97,1.96,1.60,1.97,2.07,2.08
,NCH3,s,3.02,3.00,2.94,2.57,2.96,3.31,3.06
,NCH3,s,2.94,2.83,2.78,2.05,2.83,2.92,2.90
dim et h ylform amide,CH,s,8.02,7.96,7.95,7.63,7.92,7.97,7.92
,CH3,s,2.96,2.94,2.89,2.36,2.89,2.99,3.01
,CH3,s,2.88,2.78,2.73,1.86,2.77,2.86,2.85
dim et h yl sulfoxide,CH3,s,2.62,2.52,2.54,1.68,2.50,2.65,2.71
dioxa n e,CH2,s,3.71,3.59,3.57,3.35,3.60,3.66,3.75
et h a n ol,CH3,"t, 7",1.25,1.12,1.06,0.96,1.12,1.19,1.17
,CH2,"q, 7d",3.72,3.57,3.44,3.34,3.54,3.60,3.65
,OH,"sc,d",1.32,3.39,4.63,,2.47,,
et h yl a cet at e,CH3CO,s,2.05,1.97,1.99,1.65,1.97,2.01,2.07
,CH2CH3,"q, 7",4.12,4.05,4.03,3.89,4.06,4.09,4.14
,CH2CH3,"t, 7",1.26,1.20,1.17,0.92,1.20,1.24,1.24
et h yl m et h yl ket on e,CH3CO,s,2.14,2.07,2.07,1.58,2.06,2.12,2.19
,CH2CH3,"q, 7",2.46,2.45,2.43,1.81,2.43,2.50,3.18
,CH2CH3,"t, 7",1.06,0.96,0.91,0.85,0.96,1.01,1.26
et h ylen e glycol,CH,se,3.76,3.28,3.34,3.41,3.51,3.59,3.65
“gr ea se” f,CH3,m,0.86,0.87,,0.92,0.86,0.88,
,CH2,br s,1.26,1.29,,1.36,1.27,1.29,
n-h exa n e,CH3,t,0.88,0.88,0.86,0.89,0.89,0.90,
,CH2,m,1.26,1.28,1.25,1.24,1.28,1.29,
HMPAg,CH3,"d, 9.5",2.65,2.59,2.53,2.40,2.57,2.64,2.61
m et h a n ol,CH3,sh,3.49,3.31,3.16,3.07,3.28,3.34,3.34
,OH,"sc,h",1.09,3.12,4.01,,2.16,,
nit r om et h a n e,CH3,s,4.33,4.43,4.42,2.94,4.31,4.34,4.40
n-pent a n e,CH3,"t, 7",0.88,0.88,0.86,0.87,0.89,0.90,
,CH2,m,1.27,1.27,1.27,1.23,1.29,1.29,
2-pr opa n ol,CH3,"d, 6",1.22,1.10,1.04,0.95,1.09,1.50,1.17
,CH,"sep, 6",4.04,3.90,3.78,3.67,3.87,3.92,4.02
pyridin e,CH (2),m,8.62,8.58,8.58,8.53,8.57,8.53,8.52
,CH (3),m,7.29,7.35,7.39,6.66,7.33,7.44,7.45
,CH (4),m,7.68,7.76,7.79,6.98,7.73,7.85,7.87
silicon e gr ea sei,CH3,s,0.07,0.13,,0.29,0.08,0.10,
t et r a h ydr ofu r a n,CH2,m,1.85,1.79,1.76,1.40,1.80,1.87,1.88
,CH2O,m,3.76,3.63,3.60,3.57,3.64,3.71,3.74
t olu en e,CH3,s,2.36,2.32,2.30,2.11,2.33,2.32,
,CH(o/ p),m,7.17,7.1-7.2,7.18,7.02,7.1-7.3,7.16,
,CH(m ),m,7.25,7.1-7.2,7.25,7.13,7.1-7.3,7.16,
triethylamine,CH3,"t,7",1.03,0.96,0.93,0.96,0.96,1.05,0.99
,CH2,"q, 7",2.53,2.45,2.43,2.40,2.45,2.58,2.57
"""
    if actual != expected:
        with open("test/outputs/actual/nmr2.csv", "w", encoding='utf-8') as f:
            f.write(actual)
    assert actual == expected

def test_large_table_3(doc_nmr):
    actual = load_to_str(doc_nmr, 3)
    expected = """,,CDCl3,(CD3)2CO,(CD3)2SO,C6D6,CD3CN,CD3OD,D2O
solvent sign als,,77.16 ( 0.06,29.84 ( 0.01,39.52 ( 0.06,128.06 ( 0.02,1.32 ( 0.02,49.00(0.01,
,,,206.26 ( 0.13,,,118.26 ( 0.02,,
a cetic a cid,CO,175.99,172.31,171.93,175.82,173.21,175.11,177.21
,CH3,20.81,20.51,20.95,20.37,20.73,20.56,21.03
a cet on e,CO,207.07,205.87,206.31,204.43,207.43,209.67,215.94
,CH3,30.92,30.60,30.56,30.14,30.91,30.67,30.89
a cet onit rile,CN,116.43,117.60,117.91,116.02,118.26,118.06,119.68
,CH3,1.89,1.12,1.03,0.20,1.79,0.85,1.47
benzene,CH,128.37,129.15,128.30,128.62,129.32,129.34,
tert-but yl alcoh ol,C,69.15,68.13,66.88,68.19,68.74,69.40,70.36
,CH3,31.25,30.72,30.38,30.47,30.68,30.91,30.29
tert-but yl m et h yl et h er,OCH3,49.45,49.35,48.70,49.19,49.52,49.66,49.37
,C,72.87,72.81,72.04,72.40,73.17,74.32,75.62
,CCH3,26.99,27.24,26.79,27.09,27.28,27.22,26.60
BHT,C(1),151.55,152.51,151.47,152.05,152.42,152.85,
,C(2),135.87,138.19,139.12,136.08,138.13,139.09,
,CH (3),125.55,129.05,127.97,128.52,129.61,129.49,
,C(4),128.27,126.03,124.85,125.83,126.38,126.11,
,CH3Ar,21.20,21.31,20.97,21.40,21.23,21.38,
,CH3C,30.33,31.61,31.25,31.34,31.50,31.15,
,C,34.25,35.00,34.33,34.35,35.05,35.36,
chlor oform,CH,77.36,79.19,79.16,77.79,79.17,79.44,
cycloh exa n e,CH2,26.94,27.51,26.33,27.23,27.63,27.96,
"1,2-dichlor oet h a n e",CH2,43.50,45.25,45.02,43.59,45.54,45.11,
dichlor om et h a n e,CH2,53.52,54.95,54.84,53.46,55.32,54.78,
diethyl ether,CH3,15.20,15.78,15.12,15.46,15.63,15.46,14.77
,CH2,65.91,66.12,62.05,65.94,66.32,66.88,66.42
diglyme,CH3,59.01,58.77,57.98,58.66,58.90,59.06,58.67
,CH2,70.51,71.03,69.54,70.87,70.99,71.33,70.05
,CH2,71.90,72.63,71.25,72.35,72.63,72.92,71.63
"1,2-dim et h oxyet h a n e",CH3,59.08,58.45,58.01,58.68,58.89,59.06,58.67
,CH2,71.84,72.47,17.07,72.21,72.47,72.72,71.49
dim et h yla cet amide,CH3,21.53,21.51,21.29,21.16,21.76,21.32,21.09
,CO,171.07,170.61,169.54,169.95,171.31,173.32,174.57
,NCH3,35.28,34.89,37.38,34.67,35.17,35.50,35.03
,NCH3,38.13,37.92,34.42,37.03,38.26,38.43,38.76
dim et h ylform amide,CH,162.62,162.79,162.29,162.13,163.31,164.73,165.53
,CH3,36.50,36.15,35.73,35.25,36.57,36.89,37.54
,CH3,31.45,31.03,30.73,30.72,31.32,31.61,32.03
dim et h yl sulfoxide,CH3,40.76,41.23,40.45,40.03,41.31,40.45,39.39
dioxa n e,CH2,67.14,67.60,66.36,67.16,67.72,68.11,67.19
et h a n ol,CH3,18.41,18.89,18.51,18.72,18.80,18.40,17.47
,CH2,58.28,57.72,56.07,57.86,57.96,58.26,58.05
et h yl a cet at e,CH3CO,21.04,20.83,20.68,20.56,21.16,20.88,21.15
,CO,171.36,170.96,170.31,170.44,171.68,172.89,175.26
,CH2,60.49,60.56,59.74,60.21,60.98,61.50,62.32
,CH3,14.19,14.50,14.40,14.19,14.54,14.49,13.92
et h yl m et h yl ket on e,CH3CO,29.49,29.30,29.26,28.56,29.60,29.39,29.49
,CO,209.56,208.30,208.72,206.55,209.88,212.16,218.43
,CH2CH3,36.89,36.75,35.83,36.36,37.09,37.34,37.27
,CH2CH3,7.86,8.03,7.61,7.91,8.14,8.09,7.87
et h ylen e glycol,CH2,63.79,64.26,62.76,64.34,64.22,64.30,63.17
“gr ea se”,CH2,29.76,30.73,29.20,30.21,30.86,31.29,
n-h exa n e,CH3,14.14,14.34,13.88,14.32,14.43,14.45,
,CH2(2),22.70,23.28,22.05,23.04,23.40,23.68,
,CH2(3),31.64,32.30,30.95,31.96,32.36,32.73,
HMPAb,CH3,36.87,37.04,36.42,36.88,37.10,37.00,36.46
m et h a n ol,CH3,50.41,49.77,48.59,49.97,49.90,49.86,49.50c
nit r om et h a n e,CH3,62.50,63.21,63.28,61.16,63.66,63.08,63.22
n-pent a n e,CH3,14.08,14.29,13.28,14.25,14.37,14.39,
,CH2(2),22.38,22.98,21.70,22.72,23.08,23.38,
,CH2(3),34.16,34.83,33.48,34.45,34.89,35.30,
2-pr opa n ol,CH3,25.14,25.67,25.43,25.18,25.55,25.27,24.38
,CH,64.50,63.85,64.92,64.23,64.30,64.71,64.88
pyridin e,CH (2),149.90,150.67,149.58,150.27,150.76,150.07,149.18
,CH (3),123.75,124.57,123.84,123.58,127.76,125.53,125.12
,CH (4),135.96,136.56,136.05,135.28,136.89,138.35,138.27
silicon e gr ea se,CH3,1.04,1.40,,1.38,,2.10,
t et r a h ydr ofu r a n,CH2,25.62,26.15,25.14,25.72,26.27,26.48,25.67
,CH2O,67.97,68.07,67.03,67.80,68.33,68.83,68.68
t olu en e,CH3,21.46,21.46,20.99,21.10,21.50,21.50,
,C(i),137.89,138.48,137.35,137.91,138.90,138.85,
,CH(o),129.07,129.76,128.88,129.33,129.94,129.91,
,CH(m ),128.26,129.03,128.18,128.56,129.23,129.20,
,CH(p),125.33,126.12,125.29,125.68,126.28,126.29,
triethylamine,CH3,11.61,12.49,11.74,12.35,12.38,11.09,9.07
,CH2,46.25,47.07,45.74,46.77,47.10,46.96,47.19
"""
    if actual != expected:
        print("Actual:\n", actual)
    assert actual == expected
    
def test_large_table_6(doc_nmr):
    actual = load_to_str(doc_nmr, 3)
    expected = """,,CDCl3,(CD3)2CO,(CD3)2SO,C6D6,CD3CN,CD3OD,D2O
solvent sign als,,77.16 ( 0.06,29.84 ( 0.01,39.52 ( 0.06,128.06 ( 0.02,1.32 ( 0.02,49.00(0.01,
,,,206.26 ( 0.13,,,118.26 ( 0.02,,
a cetic a cid,CO,175.99,172.31,171.93,175.82,173.21,175.11,177.21
,CH3,20.81,20.51,20.95,20.37,20.73,20.56,21.03
a cet on e,CO,207.07,205.87,206.31,204.43,207.43,209.67,215.94
,CH3,30.92,30.60,30.56,30.14,30.91,30.67,30.89
a cet onit rile,CN,116.43,117.60,117.91,116.02,118.26,118.06,119.68
,CH3,1.89,1.12,1.03,0.20,1.79,0.85,1.47
benzene,CH,128.37,129.15,128.30,128.62,129.32,129.34,
tert-but yl alcoh ol,C,69.15,68.13,66.88,68.19,68.74,69.40,70.36
,CH3,31.25,30.72,30.38,30.47,30.68,30.91,30.29
tert-but yl m et h yl et h er,OCH3,49.45,49.35,48.70,49.19,49.52,49.66,49.37
,C,72.87,72.81,72.04,72.40,73.17,74.32,75.62
,CCH3,26.99,27.24,26.79,27.09,27.28,27.22,26.60
BHT,C(1),151.55,152.51,151.47,152.05,152.42,152.85,
,C(2),135.87,138.19,139.12,136.08,138.13,139.09,
,CH (3),125.55,129.05,127.97,128.52,129.61,129.49,
,C(4),128.27,126.03,124.85,125.83,126.38,126.11,
,CH3Ar,21.20,21.31,20.97,21.40,21.23,21.38,
,CH3C,30.33,31.61,31.25,31.34,31.50,31.15,
,C,34.25,35.00,34.33,34.35,35.05,35.36,
chlor oform,CH,77.36,79.19,79.16,77.79,79.17,79.44,
cycloh exa n e,CH2,26.94,27.51,26.33,27.23,27.63,27.96,
"1,2-dichlor oet h a n e",CH2,43.50,45.25,45.02,43.59,45.54,45.11,
dichlor om et h a n e,CH2,53.52,54.95,54.84,53.46,55.32,54.78,
diethyl ether,CH3,15.20,15.78,15.12,15.46,15.63,15.46,14.77
,CH2,65.91,66.12,62.05,65.94,66.32,66.88,66.42
diglyme,CH3,59.01,58.77,57.98,58.66,58.90,59.06,58.67
,CH2,70.51,71.03,69.54,70.87,70.99,71.33,70.05
,CH2,71.90,72.63,71.25,72.35,72.63,72.92,71.63
"1,2-dim et h oxyet h a n e",CH3,59.08,58.45,58.01,58.68,58.89,59.06,58.67
,CH2,71.84,72.47,17.07,72.21,72.47,72.72,71.49
dim et h yla cet amide,CH3,21.53,21.51,21.29,21.16,21.76,21.32,21.09
,CO,171.07,170.61,169.54,169.95,171.31,173.32,174.57
,NCH3,35.28,34.89,37.38,34.67,35.17,35.50,35.03
,NCH3,38.13,37.92,34.42,37.03,38.26,38.43,38.76
dim et h ylform amide,CH,162.62,162.79,162.29,162.13,163.31,164.73,165.53
,CH3,36.50,36.15,35.73,35.25,36.57,36.89,37.54
,CH3,31.45,31.03,30.73,30.72,31.32,31.61,32.03
dim et h yl sulfoxide,CH3,40.76,41.23,40.45,40.03,41.31,40.45,39.39
dioxa n e,CH2,67.14,67.60,66.36,67.16,67.72,68.11,67.19
et h a n ol,CH3,18.41,18.89,18.51,18.72,18.80,18.40,17.47
,CH2,58.28,57.72,56.07,57.86,57.96,58.26,58.05
et h yl a cet at e,CH3CO,21.04,20.83,20.68,20.56,21.16,20.88,21.15
,CO,171.36,170.96,170.31,170.44,171.68,172.89,175.26
,CH2,60.49,60.56,59.74,60.21,60.98,61.50,62.32
,CH3,14.19,14.50,14.40,14.19,14.54,14.49,13.92
et h yl m et h yl ket on e,CH3CO,29.49,29.30,29.26,28.56,29.60,29.39,29.49
,CO,209.56,208.30,208.72,206.55,209.88,212.16,218.43
,CH2CH3,36.89,36.75,35.83,36.36,37.09,37.34,37.27
,CH2CH3,7.86,8.03,7.61,7.91,8.14,8.09,7.87
et h ylen e glycol,CH2,63.79,64.26,62.76,64.34,64.22,64.30,63.17
“gr ea se”,CH2,29.76,30.73,29.20,30.21,30.86,31.29,
n-h exa n e,CH3,14.14,14.34,13.88,14.32,14.43,14.45,
,CH2(2),22.70,23.28,22.05,23.04,23.40,23.68,
,CH2(3),31.64,32.30,30.95,31.96,32.36,32.73,
HMPAb,CH3,36.87,37.04,36.42,36.88,37.10,37.00,36.46
m et h a n ol,CH3,50.41,49.77,48.59,49.97,49.90,49.86,49.50c
nit r om et h a n e,CH3,62.50,63.21,63.28,61.16,63.66,63.08,63.22
n-pent a n e,CH3,14.08,14.29,13.28,14.25,14.37,14.39,
,CH2(2),22.38,22.98,21.70,22.72,23.08,23.38,
,CH2(3),34.16,34.83,33.48,34.45,34.89,35.30,
2-pr opa n ol,CH3,25.14,25.67,25.43,25.18,25.55,25.27,24.38
,CH,64.50,63.85,64.92,64.23,64.30,64.71,64.88
pyridin e,CH (2),149.90,150.67,149.58,150.27,150.76,150.07,149.18
,CH (3),123.75,124.57,123.84,123.58,127.76,125.53,125.12
,CH (4),135.96,136.56,136.05,135.28,136.89,138.35,138.27
silicon e gr ea se,CH3,1.04,1.40,,1.38,,2.10,
t et r a h ydr ofu r a n,CH2,25.62,26.15,25.14,25.72,26.27,26.48,25.67
,CH2O,67.97,68.07,67.03,67.80,68.33,68.83,68.68
t olu en e,CH3,21.46,21.46,20.99,21.10,21.50,21.50,
,C(i),137.89,138.48,137.35,137.91,138.90,138.85,
,CH(o),129.07,129.76,128.88,129.33,129.94,129.91,
,CH(m ),128.26,129.03,128.18,128.56,129.23,129.20,
,CH(p),125.33,126.12,125.29,125.68,126.28,126.29,
triethylamine,CH3,11.61,12.49,11.74,12.35,12.38,11.09,9.07
,CH2,46.25,47.07,45.74,46.77,47.10,46.96,47.19
"""
    if actual != expected:
        print("Actual:\n", actual)
    assert actual == expected
    
def test_large_table_7(doc_nmr):
    actual = load_to_str(doc_nmr, 3)
    expected = """,,CDCl3,(CD3)2CO,(CD3)2SO,C6D6,CD3CN,CD3OD,D2O
solvent sign als,,77.16 ( 0.06,29.84 ( 0.01,39.52 ( 0.06,128.06 ( 0.02,1.32 ( 0.02,49.00(0.01,
,,,206.26 ( 0.13,,,118.26 ( 0.02,,
a cetic a cid,CO,175.99,172.31,171.93,175.82,173.21,175.11,177.21
,CH3,20.81,20.51,20.95,20.37,20.73,20.56,21.03
a cet on e,CO,207.07,205.87,206.31,204.43,207.43,209.67,215.94
,CH3,30.92,30.60,30.56,30.14,30.91,30.67,30.89
a cet onit rile,CN,116.43,117.60,117.91,116.02,118.26,118.06,119.68
,CH3,1.89,1.12,1.03,0.20,1.79,0.85,1.47
benzene,CH,128.37,129.15,128.30,128.62,129.32,129.34,
tert-but yl alcoh ol,C,69.15,68.13,66.88,68.19,68.74,69.40,70.36
,CH3,31.25,30.72,30.38,30.47,30.68,30.91,30.29
tert-but yl m et h yl et h er,OCH3,49.45,49.35,48.70,49.19,49.52,49.66,49.37
,C,72.87,72.81,72.04,72.40,73.17,74.32,75.62
,CCH3,26.99,27.24,26.79,27.09,27.28,27.22,26.60
BHT,C(1),151.55,152.51,151.47,152.05,152.42,152.85,
,C(2),135.87,138.19,139.12,136.08,138.13,139.09,
,CH (3),125.55,129.05,127.97,128.52,129.61,129.49,
,C(4),128.27,126.03,124.85,125.83,126.38,126.11,
,CH3Ar,21.20,21.31,20.97,21.40,21.23,21.38,
,CH3C,30.33,31.61,31.25,31.34,31.50,31.15,
,C,34.25,35.00,34.33,34.35,35.05,35.36,
chlor oform,CH,77.36,79.19,79.16,77.79,79.17,79.44,
cycloh exa n e,CH2,26.94,27.51,26.33,27.23,27.63,27.96,
"1,2-dichlor oet h a n e",CH2,43.50,45.25,45.02,43.59,45.54,45.11,
dichlor om et h a n e,CH2,53.52,54.95,54.84,53.46,55.32,54.78,
diethyl ether,CH3,15.20,15.78,15.12,15.46,15.63,15.46,14.77
,CH2,65.91,66.12,62.05,65.94,66.32,66.88,66.42
diglyme,CH3,59.01,58.77,57.98,58.66,58.90,59.06,58.67
,CH2,70.51,71.03,69.54,70.87,70.99,71.33,70.05
,CH2,71.90,72.63,71.25,72.35,72.63,72.92,71.63
"1,2-dim et h oxyet h a n e",CH3,59.08,58.45,58.01,58.68,58.89,59.06,58.67
,CH2,71.84,72.47,17.07,72.21,72.47,72.72,71.49
dim et h yla cet amide,CH3,21.53,21.51,21.29,21.16,21.76,21.32,21.09
,CO,171.07,170.61,169.54,169.95,171.31,173.32,174.57
,NCH3,35.28,34.89,37.38,34.67,35.17,35.50,35.03
,NCH3,38.13,37.92,34.42,37.03,38.26,38.43,38.76
dim et h ylform amide,CH,162.62,162.79,162.29,162.13,163.31,164.73,165.53
,CH3,36.50,36.15,35.73,35.25,36.57,36.89,37.54
,CH3,31.45,31.03,30.73,30.72,31.32,31.61,32.03
dim et h yl sulfoxide,CH3,40.76,41.23,40.45,40.03,41.31,40.45,39.39
dioxa n e,CH2,67.14,67.60,66.36,67.16,67.72,68.11,67.19
et h a n ol,CH3,18.41,18.89,18.51,18.72,18.80,18.40,17.47
,CH2,58.28,57.72,56.07,57.86,57.96,58.26,58.05
et h yl a cet at e,CH3CO,21.04,20.83,20.68,20.56,21.16,20.88,21.15
,CO,171.36,170.96,170.31,170.44,171.68,172.89,175.26
,CH2,60.49,60.56,59.74,60.21,60.98,61.50,62.32
,CH3,14.19,14.50,14.40,14.19,14.54,14.49,13.92
et h yl m et h yl ket on e,CH3CO,29.49,29.30,29.26,28.56,29.60,29.39,29.49
,CO,209.56,208.30,208.72,206.55,209.88,212.16,218.43
,CH2CH3,36.89,36.75,35.83,36.36,37.09,37.34,37.27
,CH2CH3,7.86,8.03,7.61,7.91,8.14,8.09,7.87
et h ylen e glycol,CH2,63.79,64.26,62.76,64.34,64.22,64.30,63.17
“gr ea se”,CH2,29.76,30.73,29.20,30.21,30.86,31.29,
n-h exa n e,CH3,14.14,14.34,13.88,14.32,14.43,14.45,
,CH2(2),22.70,23.28,22.05,23.04,23.40,23.68,
,CH2(3),31.64,32.30,30.95,31.96,32.36,32.73,
HMPAb,CH3,36.87,37.04,36.42,36.88,37.10,37.00,36.46
m et h a n ol,CH3,50.41,49.77,48.59,49.97,49.90,49.86,49.50c
nit r om et h a n e,CH3,62.50,63.21,63.28,61.16,63.66,63.08,63.22
n-pent a n e,CH3,14.08,14.29,13.28,14.25,14.37,14.39,
,CH2(2),22.38,22.98,21.70,22.72,23.08,23.38,
,CH2(3),34.16,34.83,33.48,34.45,34.89,35.30,
2-pr opa n ol,CH3,25.14,25.67,25.43,25.18,25.55,25.27,24.38
,CH,64.50,63.85,64.92,64.23,64.30,64.71,64.88
pyridin e,CH (2),149.90,150.67,149.58,150.27,150.76,150.07,149.18
,CH (3),123.75,124.57,123.84,123.58,127.76,125.53,125.12
,CH (4),135.96,136.56,136.05,135.28,136.89,138.35,138.27
silicon e gr ea se,CH3,1.04,1.40,,1.38,,2.10,
t et r a h ydr ofu r a n,CH2,25.62,26.15,25.14,25.72,26.27,26.48,25.67
,CH2O,67.97,68.07,67.03,67.80,68.33,68.83,68.68
t olu en e,CH3,21.46,21.46,20.99,21.10,21.50,21.50,
,C(i),137.89,138.48,137.35,137.91,138.90,138.85,
,CH(o),129.07,129.76,128.88,129.33,129.94,129.91,
,CH(m ),128.26,129.03,128.18,128.56,129.23,129.20,
,CH(p),125.33,126.12,125.29,125.68,126.28,126.29,
triethylamine,CH3,11.61,12.49,11.74,12.35,12.38,11.09,9.07
,CH2,46.25,47.07,45.74,46.77,47.10,46.96,47.19
"""
    if actual != expected:
        print("Actual:\n", actual)
    assert actual == expected
    

if __name__ == "__main__":
    doc = PyPDFium2Document(f"notebooks/samples/nmr.pdf")
    
    detector = AutoTableDetector()
    formatter = AutoTableFormatter()
    
    for i in range(len(doc)):
        page = doc.get_page(i)
        tables = detector.extract(page)
        for table in tables:
            formatted_table = formatter.extract(table)
            # print(formatted_table)
            # save to disk
            with open(f"test/outputs/nmr/nmr{i}.json", "w") as f:
                # f.write() formatted_table.to_dict()
                f.write(json.dumps(formatted_table.to_dict(), indent=2))
                formatted_table.image().save(f"test/outputs/nmr/nmr{i}.png")
    doc.close()
    